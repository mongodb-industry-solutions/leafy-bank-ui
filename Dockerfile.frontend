FROM node:20.10.0

# Accept build arguments (passed from Drone)
ARG NEXT_PUBLIC_ACCOUNTS_API_URL
ARG NEXT_PUBLIC_TRANSACTIONS_API_URL
ARG NEXT_PUBLIC_CROSS_BACKEND_PDF_RAG_URL
ARG NEXT_PUBLIC_OPEN_FINANCE_API_URL
ARG NEXT_PUBLIC_CAPITALMARKETS_LOADERS_API_URL
ARG NEXT_PUBLIC_CAPITALMARKETS_AGENTS_API_URL
ARG NEXT_PUBLIC_CAPITALMARKETS_REACT_STOCK_API_URL
ARG NEXT_PUBLIC_CAPITALMARKETS_REACT_CRYPTO_API_URL
ARG NODE_ENV=dev

# Set environment variables for Next.js build process
ENV NEXT_PUBLIC_ACCOUNTS_API_URL=$NEXT_PUBLIC_ACCOUNTS_API_URL
ENV NEXT_PUBLIC_TRANSACTIONS_API_URL=$NEXT_PUBLIC_TRANSACTIONS_API_URL
ENV NEXT_PUBLIC_CROSS_BACKEND_PDF_RAG_URL=$NEXT_PUBLIC_CROSS_BACKEND_PDF_RAG_URL
ENV NEXT_PUBLIC_OPEN_FINANCE_API_URL=$NEXT_PUBLIC_OPEN_FINANCE_API_URL
ENV NEXT_PUBLIC_CAPITALMARKETS_LOADERS_API_URL=$NEXT_PUBLIC_CAPITALMARKETS_LOADERS_API_URL
ENV NEXT_PUBLIC_CAPITALMARKETS_AGENTS_API_URL=$NEXT_PUBLIC_CAPITALMARKETS_AGENTS_API_URL
ENV NEXT_PUBLIC_CAPITALMARKETS_REACT_STOCK_API_URL=$NEXT_PUBLIC_CAPITALMARKETS_REACT_STOCK_API_URL
ENV NEXT_PUBLIC_CAPITALMARKETS_REACT_CRYPTO_API_URL=$NEXT_PUBLIC_CAPITALMARKETS_REACT_CRYPTO_API_URL
ENV NODE_ENV=$NODE_ENV

WORKDIR /app
COPY frontend/package*.json ./
RUN npm install --legacy-peer-deps
COPY frontend/ .

# Set the port environment variable for Next.js
ENV PORT=8080

RUN npm run build

EXPOSE 8080
CMD ["npm", "run", "start"]